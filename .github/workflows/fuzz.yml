name: Fuzz Test

on:
  push:
    branches: [main, fuzz]

  pull_request:
    branches: [main]
    paths:
      - "cli/**"
      - "internal/**"
      - "api/**"
      - "test/**"

  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode"
        type: choice
        options:
          - static      # generate + YAML validate + static analysis only
          - full         # static + Docker build + Kind deploy + e2e
        default: static
      provider:
        description: "LLM provider"
        type: choice
        options:
          - openai
          - anthropic
        default: openai
      model:
        description: "Model override (leave empty for provider default)"
        required: false
        type: string
      repos:
        description: "Repo list: 'discover' uses freshly discovered repos.txt (default), 'curated' uses repos-seed.txt, 'e2e' uses repos-e2e.txt"
        type: choice
        options:
          - discover
          - curated
          - e2e
        default: discover
      discover_limit:
        description: "Max repos when using discover mode"
        required: false
        type: number
        default: 20

  schedule:
    - cron: "0 6 * * 1"  # Every Monday at 06:00 UTC

permissions:
  contents: read

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # E2E â€” Operator + CLI + Generate Pipeline (runs on every push/PR)
  #
  # Builds from source, creates a Kind cluster, deploys the
  # operator, and runs:
  #   Tier 1: Operator baseline (hardcoded DSE, dependencies, GC)
  #   Tier 2: CLI features (secrets, env, load, runners, reset)
  #   Tier 3: find-repos.py discovers repos, merges with curated
  #           repos-e2e.txt, then run.sh runs each through:
  #           generate â†’ YAML validate â†’ static analysis
  #           â†’ Docker build â†’ deploy â†’ e2e networking
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  e2e:
    name: "E2E (operator + CLI + generate pipeline)"
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      HAS_API_KEY: ${{ secrets.OPENAI_API_KEY != '' }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python deps
        run: pip install pyyaml

      - name: Install Kind
        run: |
          [ -f /usr/local/bin/kind ] || {
            curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.25.0/kind-linux-amd64
            chmod +x ./kind
            sudo mv ./kind /usr/local/bin/kind
          }
          kind version

      - name: Install kubectl
        run: |
          curl -Lo kubectl "https://dl.k8s.io/release/$(curl -sL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/kubectl
          kubectl version --client

      - name: Build CLI
        run: make cli

      - name: Build operator image
        run: make docker-build

      - name: Verify CLI binary
        run: ./bin/kindling version

      - name: Run E2E tests (Tiers 1 + 2)
        run: |
          chmod +x test/e2e/e2e_test.sh
          test/e2e/e2e_test.sh
        env:
          KINDLING: ${{ github.workspace }}/bin/kindling
          E2E_CLUSTER_NAME: kindling-e2e
          FUZZ_PROVIDER: openai
          KEEP_CLUSTER: "1"

      # â”€â”€ Tier 3: Discover repos â†’ generate â†’ static â†’ e2e â”€â”€â”€â”€â”€
      - name: Discover repos
        if: env.HAS_API_KEY == 'true'
        working-directory: test/fuzz
        run: |
          python3 find-repos.py \
            --token "${{ secrets.GITHUB_TOKEN }}" \
            --out repos-discovered.txt \
            --limit 5
          echo "â”€â”€ Discovered repos â”€â”€"
          cat repos-discovered.txt | grep -v '^#' | grep -v '^$' || true

          # Merge curated e2e list + discovered repos (deduplicated)
          cat repos-e2e.txt repos-discovered.txt \
            | grep -v '^#' | grep -v '^$' \
            | sort -u > repos-pipeline.txt
          echo ""
          echo "â”€â”€ Pipeline repos (curated + discovered) â”€â”€"
          cat repos-pipeline.txt

      - name: "Generate pipeline (curated + discovered repos)"
        if: env.HAS_API_KEY == 'true'
        working-directory: test/fuzz
        run: bash run.sh repos-pipeline.txt /tmp/fuzz-results "${{ github.workspace }}/bin/kindling"
        env:
          FUZZ_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          FUZZ_PROVIDER: openai
          FUZZ_CLUSTER: kindling-e2e
          FUZZ_NAMESPACE: default

      - name: Generate pipeline summary
        if: always() && env.HAS_API_KEY == 'true'
        run: |
          if [ -d /tmp/fuzz-results ]; then
            python3 test/fuzz/summarize.py /tmp/fuzz-results \
              --mode full --ai-provider openai \
              >> "$GITHUB_STEP_SUMMARY" || true
          fi

      - name: Upload pipeline results
        if: always() && env.HAS_API_KEY == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: e2e-pipeline-results-${{ github.run_id }}
          path: /tmp/fuzz-results/
          retention-days: 14
          if-no-files-found: ignore

      - name: Dump cluster state on failure
        if: failure()
        run: |
          echo "=== Pods (all namespaces) ==="
          kubectl get pods -A -o wide || true
          echo ""
          echo "=== Events ==="
          kubectl get events --sort-by=.lastTimestamp -A | tail -50 || true
          echo ""
          echo "=== Operator logs ==="
          kubectl logs deployment/kindling-controller-manager -n kindling-system --tail=80 || true
          echo ""
          echo "=== DSEs ==="
          kubectl get dse -A -o yaml || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Fuzz â€” Wild-repo generate testing (workflow_dispatch only)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  fuzz:
    if: github.event_name == 'workflow_dispatch'
    needs: [e2e]
    name: "Fuzz (${{ inputs.mode || 'static' }})"
    runs-on: ubuntu-latest
    timeout-minutes: 120

    env:
      FUZZ_PROVIDER: ${{ inputs.provider || 'openai' }}
      FUZZ_API_KEY: ${{ inputs.provider == 'anthropic' && secrets.ANTHROPIC_API_KEY || secrets.OPENAI_API_KEY }}
      FUZZ_MODEL: ${{ inputs.model || '' }}

    steps:
      - uses: actions/checkout@v4

      # â”€â”€ Install kindling CLI from latest release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install kindling CLI
        run: |
          set -euo pipefail
          RELEASE_URL=$(gh api repos/${{ github.repository }}/releases/latest \
            --jq '.assets[] | select(.name | test("linux.*amd64.*tar.gz$")) | .browser_download_url')
          echo "ðŸ“¦ Downloading $RELEASE_URL"
          curl -sL "$RELEASE_URL" | tar xz -C /usr/local/bin kindling
          kindling version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ Python for analyze.py / find-repos.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python deps
        run: pip install pyyaml

      # â”€â”€ Discover fresh repos (always runs) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Discover repos
        run: |
          cd test/fuzz
          python3 find-repos.py \
            --token "${{ secrets.GITHUB_TOKEN }}" \
            --out repos.txt \
            --limit ${{ inputs.discover_limit || 20 }}
          echo "â”€â”€ Discovered repos â”€â”€"
          grep -v '^#' repos.txt | grep -v '^$' | head -30

      - name: Set repos file
        run: |
          if [[ "${{ inputs.repos }}" == "e2e" ]]; then
            echo "REPOS_FILE=repos-e2e.txt" >> "$GITHUB_ENV"
          elif [[ "${{ inputs.repos }}" == "curated" ]]; then
            echo "REPOS_FILE=repos-seed.txt" >> "$GITHUB_ENV"
          else
            echo "REPOS_FILE=repos.txt" >> "$GITHUB_ENV"
          fi

      # â”€â”€ Set up Kind cluster (full mode only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create Kind cluster
        if: inputs.mode == 'full'
        run: |
          [ -f /usr/local/bin/kind ] || {
            curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
            chmod +x ./kind
            sudo mv ./kind /usr/local/bin/kind
          }
          kind create cluster --name fuzz --config kind-config.yaml
          kubectl cluster-info --context kind-fuzz

      - name: Install kindling operator
        if: inputs.mode == 'full'
        run: |
          kindling init --cluster fuzz --skip-cluster
          echo "Waiting for operator..."
          kubectl wait --for=condition=available deployment/kindling-controller-manager \
            -n kindling-system --timeout=120s
          kubectl get pods -n kindling-system

      # â”€â”€ Run fuzz tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run fuzz tests
        working-directory: test/fuzz
        run: |
          SKIP_E2E=${{ inputs.mode == 'full' && '0' || '1' }}
          export SKIP_E2E

          bash run.sh "$REPOS_FILE" /tmp/fuzz-results kindling

      # â”€â”€ Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Print summary
        if: always()
        run: |
          python3 test/fuzz/summarize.py \
            /tmp/fuzz-results \
            "${{ inputs.mode || 'static' }}" \
            "${{ inputs.provider || 'openai' }}" \
            >> "$GITHUB_STEP_SUMMARY"

      - name: Generate action items
        if: always()
        run: python3 test/fuzz/summarize.py /tmp/fuzz-results --action-items

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-results-${{ github.run_id }}
          path: /tmp/fuzz-results/
          retention-days: 30

      # â”€â”€ Fail the job if generate rate < 80% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Check pass rate
        if: always()
        run: python3 test/fuzz/summarize.py /tmp/fuzz-results --check-rate 80
