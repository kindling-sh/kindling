name: E2E – Refactor Validation

on:
  push:
    branches: [refactor]
  pull_request:
    branches: [main]
    paths:
      - "cli/**"

permissions:
  contents: read

jobs:
  e2e-refactor:
    name: Full-stack E2E (Kind cluster)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ── Setup ────────────────────────────────────────────────────────────
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install Kind
        run: |
          [ -f /usr/local/bin/kind ] || {
            curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.25.0/kind-linux-amd64
            chmod +x ./kind
            sudo mv ./kind /usr/local/bin/kind
          }
          kind version

      - name: Install kubectl
        run: |
          curl -Lo kubectl "https://dl.k8s.io/release/$(curl -sL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/kubectl
          kubectl version --client

      # ── Build everything ─────────────────────────────────────────────────
      - name: Build CLI
        run: make cli

      - name: Build operator image
        run: make docker-build

      - name: Verify CLI binary
        run: ./bin/kindling version

      # ── Cluster bootstrap ────────────────────────────────────────────────
      - name: Create Kind cluster
        run: |
          kind create cluster --name e2e-refactor --wait 60s
          kubectl cluster-info --context kind-e2e-refactor

      - name: Load operator image into Kind
        run: kind load docker-image controller:latest --name e2e-refactor

      - name: Install CRDs
        run: make install

      - name: Deploy operator
        run: make deploy IMG=controller:latest

      - name: Wait for operator
        run: |
          kubectl rollout status deployment/kindling-controller-manager \
            -n kindling-system --timeout=120s

      # ── Run E2E test script ──────────────────────────────────────────────
      - name: Run E2E tests
        run: |
          chmod +x test/e2e/e2e-refactor.sh
          test/e2e/e2e-refactor.sh
        env:
          KINDLING: ${{ github.workspace }}/bin/kindling
          CLUSTER_NAME: e2e-refactor

      # ── Diagnostics on failure ───────────────────────────────────────────
      - name: Dump cluster state on failure
        if: failure()
        run: |
          echo "=== Pods (all namespaces) ==="
          kubectl get pods -A -o wide || true
          echo ""
          echo "=== Events ==="
          kubectl get events --sort-by=.lastTimestamp -A | tail -50 || true
          echo ""
          echo "=== Operator logs ==="
          kubectl logs deployment/kindling-controller-manager -n kindling-system --tail=80 || true
          echo ""
          echo "=== DSEs ==="
          kubectl get dse -A -o yaml || true

      - name: Cleanup
        if: always()
        run: kind delete cluster --name e2e-refactor || true
