# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# dev-deploy.yml â€” Build and deploy all microservices to your local
# Kind cluster via kindling.
#
# Uses reusable kindling actions:
#   - kindling-build:  Kaniko image build via sidecar
#   - kindling-deploy: DSE apply + rollout wait via sidecar
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
name: Microservices Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: "registry:5000"
  TAG: "${{ github.actor }}-${{ github.sha }}"

jobs:
  build-and-deploy:
    runs-on: [self-hosted, "${{ github.actor }}"]

    steps:
      # â”€â”€ 0. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Clean builds directory
        shell: bash
        run: |
          rm -f /builds/*.done /builds/*.request /builds/*.processing \
                /builds/*.apply /builds/*.apply-done /builds/*.apply-log \
                /builds/*.apply-exitcode /builds/*.exitcode \
                /builds/*.log /builds/*.dest /builds/*.tar.gz \
                /builds/*.yaml /builds/*.sh

      # â”€â”€ 0b. Parse [kindling:svc1,svc2] tag from commit message â”€
      - name: Detect selective services
        id: filter
        shell: bash
        run: |
          MSG=$(git log -1 --format=%B)
          SVCS=$(echo "$MSG" | sed -n 's/.*\[kindling:\([a-zA-Z0-9_,.-]*\)\].*/\1/p' | head -1)
          if [ -z "$SVCS" ]; then
            echo "services=all" >> "$GITHUB_OUTPUT"
            echo "ğŸ“¦ Full rebuild â€” all services"
          else
            echo "services=$SVCS" >> "$GITHUB_OUTPUT"
            echo "ğŸ·ï¸  Selective rebuild: $SVCS"
          fi

      # â”€â”€ 1. Build images â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Build orders image
        if: contains(steps.filter.outputs.services, 'all') || contains(steps.filter.outputs.services, 'orders')
        uses: jeff-vincent/kindling/.github/actions/kindling-build@main
        with:
          name: ms-orders
          context: "${{ github.workspace }}/orders"
          image: "${{ env.REGISTRY }}/ms-orders:${{ env.TAG }}"

      - name: Build inventory image
        if: contains(steps.filter.outputs.services, 'all') || contains(steps.filter.outputs.services, 'inventory')
        uses: jeff-vincent/kindling/.github/actions/kindling-build@main
        with:
          name: ms-inventory
          context: "${{ github.workspace }}/inventory"
          image: "${{ env.REGISTRY }}/ms-inventory:${{ env.TAG }}"

      - name: Build gateway image
        if: contains(steps.filter.outputs.services, 'all') || contains(steps.filter.outputs.services, 'gateway')
        uses: jeff-vincent/kindling/.github/actions/kindling-build@main
        with:
          name: ms-gateway
          context: "${{ github.workspace }}/gateway"
          image: "${{ env.REGISTRY }}/ms-gateway:${{ env.TAG }}"

      - name: Build UI image
        if: contains(steps.filter.outputs.services, 'all') || contains(steps.filter.outputs.services, 'ui')
        uses: jeff-vincent/kindling/.github/actions/kindling-build@main
        with:
          name: ms-ui
          context: "${{ github.workspace }}/ui"
          image: "${{ env.REGISTRY }}/ms-ui:${{ env.TAG }}"

      # â”€â”€ 2. Deploy services â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Deploy orders
        if: contains(steps.filter.outputs.services, 'all') || contains(steps.filter.outputs.services, 'orders')
        uses: jeff-vincent/kindling/.github/actions/kindling-deploy@main
        with:
          name: "${{ github.actor }}-orders"
          image: "${{ env.REGISTRY }}/ms-orders:${{ env.TAG }}"
          port: "5000"
          health-check-path: "/api/v1/health"
          labels: |
            app.kubernetes.io/part-of: microservices-demo
            app.kubernetes.io/component: orders
            apps.example.com/github-username: ${{ github.actor }}
          dependencies: |
            - type: postgres
              version: "16"
            - type: redis

      - name: Deploy inventory
        if: contains(steps.filter.outputs.services, 'all') || contains(steps.filter.outputs.services, 'inventory')
        uses: jeff-vincent/kindling/.github/actions/kindling-deploy@main
        with:
          name: "${{ github.actor }}-inventory"
          image: "${{ env.REGISTRY }}/ms-inventory:${{ env.TAG }}"
          port: "3000"
          health-check-path: "/healthcheck"
          labels: |
            app.kubernetes.io/part-of: microservices-demo
            app.kubernetes.io/component: inventory
            apps.example.com/github-username: ${{ github.actor }}
          env: |
            - name: EVENT_STORE_URL
              value: "redis://${{ github.actor }}-orders-redis:6379/0"
          dependencies: |
            - type: mongodb

      - name: Deploy gateway
        if: contains(steps.filter.outputs.services, 'all') || contains(steps.filter.outputs.services, 'gateway')
        uses: jeff-vincent/kindling/.github/actions/kindling-deploy@main
        with:
          name: "${{ github.actor }}-gateway"
          image: "${{ env.REGISTRY }}/ms-gateway:${{ env.TAG }}"
          port: "9090"
          health-check-path: "/-/ready"
          labels: |
            app.kubernetes.io/part-of: microservices-demo
            app.kubernetes.io/component: gateway
            apps.example.com/github-username: ${{ github.actor }}
          env: |
            - name: ORDERS_URL
              value: "http://${{ github.actor }}-orders:5000"
            - name: INVENTORY_URL
              value: "http://${{ github.actor }}-inventory:3000"

      - name: Deploy UI dashboard
        if: contains(steps.filter.outputs.services, 'all') || contains(steps.filter.outputs.services, 'ui')
        uses: jeff-vincent/kindling/.github/actions/kindling-deploy@main
        with:
          name: "${{ github.actor }}-ui"
          image: "${{ env.REGISTRY }}/ms-ui:${{ env.TAG }}"
          port: "80"
          health-check-path: "/"
          labels: |
            app.kubernetes.io/part-of: microservices-demo
            app.kubernetes.io/component: ui
            apps.example.com/github-username: ${{ github.actor }}
          env: |
            - name: GATEWAY_URL
              value: "http://${{ github.actor }}-gateway:9090"
          ingress-host: "${{ github.actor }}-ui.localhost"

      # â”€â”€ 3. Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy summary
        run: |
          echo ""
          echo "ğŸ‰ Deploy complete!"
          echo ""
          echo "ğŸ¨ UI dashboard: http://${{ github.actor }}-ui.localhost"
          echo "ğŸ“¡ Fallback:     kubectl port-forward svc/${{ github.actor }}-gateway 9090:9090"
